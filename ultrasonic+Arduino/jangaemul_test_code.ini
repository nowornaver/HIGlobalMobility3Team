import serial
import time
import sys

# ì‹œë¦¬ì–¼ í¬íŠ¸ ì„¤ì •
serial_port = serial.Serial('COM8', 9600, timeout=1)
time.sleep(2)

# ê±°ë¦¬ ê¸°ì¤€
OBSTACLE_DETECT_THRESHOLD = 100      # ì¥ì• ë¬¼ ê°ì§€ ê¸°ì¤€ (cm)
AVOID_TARGET_DISTANCE = 200          # íšŒí”¼ ì „ì§„ ëª©í‘œ (ì˜¤ë¥¸ìª½ ì„¼ì„œê°’ â‰¤ 200)
AVOID_CONFIRM_COUNT = 5              # ì—°ì† íšŒí”¼ ê±°ë¦¬ ë§Œì¡± íšŸìˆ˜

# ì¡°í–¥ê° ê°’
STEERING_RIGHT = 15
STEERING_LEFT = -15
STEERING_TOLERANCE = 2

# ìƒíƒœ ì •ì˜
state = "WAYPOINT_FOLLOWING"
avoid_forward_count = 0
steering_direction = 0

# ì´ì „ ê°’ ê¸°ë¡ìš©
last_left = None
last_right = None
last_state = None
last_count = None

def get_distances():
    """ì™¼ìª½ê³¼ ì˜¤ë¥¸ìª½ ê±°ë¦¬ê°’ ì½ì–´ì˜´"""
    line = None
    while serial_port.in_waiting:
        line = serial_port.readline().decode('utf-8').strip()

    if line:
        try:
            _, left, right = line.split(",")
            return float(left), float(right)
        except ValueError:
            print("ê±°ë¦¬ íŒŒì‹± ì‹¤íŒ¨:", line)
    return None, None

def print_status(left, right, state, count):
    sys.stdout.write(
        f"\rğŸ“ ì™¼ìª½: {left:6.1f} cm | ì˜¤ë¥¸ìª½: {right:6.1f} cm | ìƒíƒœ: {state:<20} | íšŒí”¼ ì¹´ìš´íŠ¸: {count}"
    )
    sys.stdout.flush()

def main():
    global state, avoid_forward_count, steering_direction
    global last_left, last_right, last_state, last_count

    while True:
        left, right = get_distances()
        if left is None or right is None:
            continue

        # ë³€í™”ê°€ ìˆì„ ë•Œë§Œ ì¶œë ¥
        if (left != last_left or right != last_right or
            state != last_state or avoid_forward_count != last_count):
            print_status(left, right, state, avoid_forward_count)
            last_left, last_right = left, right
            last_state = state
            last_count = avoid_forward_count

        if state == "WAYPOINT_FOLLOWING":
            if left <= OBSTACLE_DETECT_THRESHOLD or right <= OBSTACLE_DETECT_THRESHOLD:
                print("\nğŸ›‘ ì¥ì• ë¬¼ ê°ì§€ë¨ â†’ íšŒí”¼ ì‹œì‘")

                if left > right:
                    steering_direction = STEERING_LEFT
                    print("â†©ï¸ ì™¼ìª½ì´ ë„“ìŒ â†’ ì™¼ìª½ìœ¼ë¡œ ì¡°í–¥")
                else:
                    steering_direction = STEERING_RIGHT
                    print("â†ªï¸ ì˜¤ë¥¸ìª½ì´ ë„“ìŒ â†’ ì˜¤ë¥¸ìª½ìœ¼ë¡œ ì¡°í–¥")

                state = "AVOID_FORWARD"
                avoid_forward_count = 0

        elif state == "AVOID_FORWARD":
            if right <= AVOID_TARGET_DISTANCE:
                avoid_forward_count += 1
                print(f"\nğŸš— ì „ì§„ ì¤‘... (ì˜¤ë¥¸ìª½ ê±°ë¦¬: {right:.1f} cm) â†’ ì¹´ìš´íŠ¸: {avoid_forward_count}")
                if avoid_forward_count >= AVOID_CONFIRM_COUNT:
                    print("âœ… íšŒí”¼ ì™„ë£Œ â†’ ì¡°í–¥ê° ì´ˆê¸°í™” ë° ì›¨ì´í¬ì¸íŠ¸ ë³µê·€")
                    steering_direction = 0
                    state = "WAYPOINT_FOLLOWING"
            else:
                avoid_forward_count = 0

        time.sleep(0.1)

    serial_port.close()

if __name__ == "__main__":
    main()
